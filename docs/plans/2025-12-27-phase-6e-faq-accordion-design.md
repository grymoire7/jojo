# Phase 6e: FAQ Accordion - Design Document

**Date:** 2025-12-27
**Phase:** 6e - FAQ Accordion
**Status:** Design Complete, Ready for Implementation

## Overview

Add an interactive FAQ accordion section to the landing page that answers common questions about the candidate's experience, preferences, and fit for the role. The FAQ will be fully AI-generated to ensure every question is highly relevant to the specific role and company.

## Design Decisions

### Content Generation Strategy

**Fully AI-Generated:** All FAQ questions and answers are generated by AI (reasoning model) based on:
- Job description analysis
- Resume content
- Company research insights
- Job details (title, company name)

No manual input required per application. This ensures:
- Maximum relevance to each specific role
- Zero additional work per application
- Consistent quality and professionalism
- Dynamic adaptation to job requirements

### FAQ Categories

The AI will generate 5-8 questions covering these categories:

1. **Tech Stack/Tools** - Specific experience with technologies mentioned in job description
2. **Remote Work** - Setup, preferences, timezone, communication practices
3. **AI Philosophy** - How candidate uses AI tools, philosophy on AI in development
4. **Why This Company/Role** - Tailored motivation based on research insights
5. **Role-Specific Questions** - 1-2 questions unique to this job (e.g., "Experience with healthcare compliance?" for healthtech role)
6. **Resume & Cover Letter Downloads** - Dedicated FAQ with PDF download links

### Accordion Behavior

**Single Expand Mode:** Only one FAQ can be open at a time. Opening a new FAQ automatically closes the currently open one. This provides:
- Cleaner, more focused reading experience
- Guides users through questions sequentially
- Reduces visual clutter
- Mobile-friendly (less scrolling)

### Visual Style

- **Card-based accordion** with white FAQ items on light gray background
- **Question buttons** with chevron icons that rotate on expand
- **Smooth animations** for expand/collapse (300ms)
- **Active state indicators** (blue accent border)
- Matches existing template aesthetic

### Page Position

Order: Masthead → Branding → Job Description → Recommendations → Projects → **FAQ** → CTA → Footer

**Rationale:** Natural storytelling arc - user sees pitch, detailed comparison, social proof, work examples, then gets specific questions answered before the call to action. FAQ addresses any remaining hesitations right before CTA.

## Architecture

### Component Breakdown

1. **FaqGenerator** (`lib/jojo/generators/faq_generator.rb`)
   - New generator class following existing generator pattern
   - Calls AI with comprehensive context
   - Parses JSON response into structured data
   - Saves to `employers/{slug}/faq.json` for inspection/debugging
   - Returns array of FAQ hashes

2. **FaqPrompt** (`lib/jojo/prompts/faq_prompt.rb`)
   - Builds prompt with all context
   - Specifies required categories
   - Defines output format (JSON)
   - Includes answer guidelines (length, tone, specificity)

3. **WebsiteGenerator** (enhanced)
   - Calls FaqGenerator during website generation
   - Passes FAQ data to template variables
   - Handles graceful degradation

4. **Template** (`templates/website/default.html.erb`, enhanced)
   - New CSS for accordion styling
   - New HTML section between projects and CTA
   - New JavaScript for accordion behavior

### Data Flow

```
Job Description + Resume + Research + Job Details
                    ↓
              FaqPrompt.generate
                    ↓
      AI Client (reasoning model - Sonnet)
                    ↓
       JSON array of {question, answer}
                    ↓
         FaqGenerator.parse_and_save
                    ↓
    Save to faq.json + return to WebsiteGenerator
                    ↓
           Pass to template variables
                    ↓
         Render HTML accordion section
```

### Data Structure

**FAQ Item:**
```ruby
{
  question: "What's your experience with Python and Django?",
  answer: "I have 7 years of Python experience, including 5 years with Django..."
}
```

**Array returned by FaqGenerator:**
```ruby
[
  { question: "...", answer: "..." },
  { question: "...", answer: "..." },
  # ... 5-8 total FAQs
]
```

**JSON saved to faq.json:**
```json
[
  {
    "question": "What's your experience with Python and Django?",
    "answer": "I have 7 years of Python experience..."
  }
]
```

### Graceful Degradation

- AI generation fails → log warning, skip FAQ section, continue with rest of website
- Malformed JSON from AI → log error, skip FAQ section
- No research available → AI generates FAQs without research context (still useful)
- Resume/cover letter files not found → skip document download FAQ
- Empty FAQ array → section not rendered in template

## AI Prompt Strategy

### Prompt Context

The prompt will include:
- Full job description
- Full resume content
- Company research (if available)
- Job details (title, company name)
- Base URL (for constructing PDF links)
- Voice and tone from config
- Seeker name

### Prompt Instructions

The AI will be instructed to:

1. **Generate 5-8 questions** covering required categories:
   - Tech stack/tools experience
   - Remote work preferences/setup
   - AI philosophy/usage
   - Why this company/role
   - 1-2 role-specific questions
   - Resume and cover letter download links

2. **Answer Guidelines:**
   - Length: 50-150 words per answer
   - Use specific evidence from resume (numbers, companies, projects)
   - Reference research insights when relevant
   - Maintain specified voice and tone
   - Be honest and accurate (no fabrication)

3. **Output Format:**
   - Valid JSON array
   - Each item has `question` and `answer` fields
   - Questions end with "?"
   - Answers are plain text paragraphs

4. **Special Requirements:**
   - Include a dedicated FAQ for resume/cover letter with download links
   - Use base_url to construct proper PDF URLs
   - Make "why this company" answer reference specific research insights

### Example Prompt Output

```json
[
  {
    "question": "What's your experience with Python and distributed systems?",
    "answer": "I have 7 years of Python experience, including building distributed systems at Acme Corp that handled 50,000 requests per second. I designed a fault-tolerant message queue using RabbitMQ and implemented service discovery with Consul. My work on the payment processing system required deep understanding of consistency models and conflict resolution."
  },
  {
    "question": "How do you approach remote work?",
    "answer": "I've worked remotely for 5 years across Pacific and Eastern time zones. I maintain strong async communication through detailed PR descriptions and documentation. I use Slack for quick questions, Zoom for pair programming, and Notion for project specs. I have a dedicated home office with fiber internet and backup connectivity."
  },
  {
    "question": "What's your philosophy on using AI tools in development?",
    "answer": "I view AI as a force multiplier for productivity. I use Claude and GPT-4 for code review, test generation, and exploring unfamiliar APIs. However, I never blindly accept AI suggestions - I review every line, understand the trade-offs, and adapt solutions to project patterns. AI helps me move faster on routine tasks so I can focus energy on architecture and complex problems."
  },
  {
    "question": "Why are you interested in working at Acme Corp?",
    "answer": "Acme's mission to democratize financial services resonates with my experience building payment systems at Beta Inc. I'm particularly excited about your recent Series B funding and expansion into Latin American markets - my Spanish fluency and experience with multi-currency systems would be directly applicable. Your engineering blog posts on event sourcing align perfectly with my architectural approach."
  },
  {
    "question": "Have you worked with healthcare compliance standards?",
    "answer": "While I haven't directly implemented HIPAA compliance, I have extensive experience with PCI-DSS compliance at Beta Inc, which shares similar principles around data encryption, access controls, and audit logging. I've designed systems with role-based access control, encrypted data at rest and in transit, and implemented comprehensive audit trails. I'm excited to apply these security-first principles to healthcare."
  },
  {
    "question": "Where can I find your resume and cover letter?",
    "answer": "You can download my full resume and cover letter tailored specifically for this role: <a href=\"https://example.com/resume/acme-corp\">View Resume</a> | <a href=\"https://example.com/cover-letter/acme-corp\">View Cover Letter</a>"
  }
]
```

### Prompt Error Handling

- AI returns non-JSON → catch parsing error, log, skip FAQ section
- AI returns empty array → log warning, skip FAQ section
- AI returns malformed objects (missing fields) → filter out invalid items, use valid ones
- AI generates too few questions (<3) → log warning but use what's available
- AI generates too many questions (>10) → use first 8

## Visual Design

### Section Layout

```html
<section class="faq">
  <h2>Your Questions, Answered</h2>
  <div class="faq-accordion" role="region" aria-label="Frequently asked questions">
    <div class="faq-item">
      <button class="faq-question" aria-expanded="false" aria-controls="answer-0">
        Question text?
        <span class="faq-chevron" aria-hidden="true">›</span>
      </button>
      <div class="faq-answer" id="answer-0">
        <p>Answer content...</p>
      </div>
    </div>
    <!-- Repeat for each FAQ -->
  </div>
</section>
```

### CSS Styling

**Section Container:**
- Background: `var(--background-alt)` (#f9fafb, light gray)
- Padding: 2rem desktop, 1.5rem mobile
- Border-radius: 8px
- Margin: 3rem 0

**Accordion Container:**
- Display: flex column
- Gap: 0.75rem between items

**FAQ Item:**
- Background: `var(--background)` (white)
- Border: 1px solid `var(--border-color)`
- Border-radius: 6px
- Overflow: hidden
- Transition: border-color 200ms

**Question Button:**
- Full width, text-align left
- Font-size: 1.125rem
- Font-weight: 600
- Color: `var(--text-color)`
- Padding: 1rem 3rem 1rem 1rem
- Background: transparent
- Border: none
- Cursor: pointer
- Position: relative
- Transition: background-color 200ms

**Question Button States:**
- Hover: background-color rgba(0,0,0,0.02)
- Active/Expanded: border-left 3px solid `var(--primary-color)`
- Focus: outline 2px solid `var(--primary-color)`, outline-offset 2px

**Chevron Icon:**
- Position: absolute, right 1rem
- Font-size: 1.5rem
- Color: `var(--text-light)`
- Transition: transform 200ms ease
- Rotates 90deg when expanded

**Answer Container:**
- Max-height: 0
- Overflow: hidden
- Transition: max-height 300ms ease-in-out
- When expanded: max-height set to scrollHeight

**Answer Content:**
- Padding: 0 1rem 1rem 1rem
- Font-size: 1rem
- Line-height: 1.7
- Color: `var(--text-color)`

**Answer Links (resume/cover letter):**
- Color: `var(--primary-color)`
- Font-weight: 500
- Text-decoration: none
- Hover: text-decoration underline
- Margin: 0 0.5rem (spacing between links)

### Responsive Design

**Desktop (>640px):**
- Full padding and spacing
- Chevron visible
- Smooth animations

**Mobile (≤640px):**
- Reduced padding: 1.5rem section, 0.875rem items
- Smaller font-size: 1rem questions, 0.9rem answers
- Chevron slightly smaller
- Same smooth animations (still performant)

## JavaScript Behavior

### State Management

```javascript
{
  currentlyOpenIndex: null,  // null = all closed, number = index of open FAQ
  faqItems: NodeList,        // All .faq-item elements
  isAnimating: false         // Prevent rapid clicks during transition
}
```

### Core Functions

**1. toggleFaq(index)**
```javascript
function toggleFaq(index) {
  if (isAnimating) return;

  if (currentlyOpenIndex === index) {
    // Clicking currently open FAQ - close it
    closeFaq(index);
    currentlyOpenIndex = null;
  } else {
    // Opening a new FAQ
    if (currentlyOpenIndex !== null) {
      closeFaq(currentlyOpenIndex);
    }
    openFaq(index);
    currentlyOpenIndex = index;
  }
}
```

**2. openFaq(index)**
```javascript
function openFaq(index) {
  const item = faqItems[index];
  const button = item.querySelector('.faq-question');
  const answer = item.querySelector('.faq-answer');

  isAnimating = true;

  // Set max-height to scrollHeight for smooth animation
  answer.style.maxHeight = answer.scrollHeight + 'px';

  // Update visual state
  button.classList.add('active');
  button.setAttribute('aria-expanded', 'true');

  // Clear animation lock after transition
  setTimeout(() => { isAnimating = false; }, 300);
}
```

**3. closeFaq(index)**
```javascript
function closeFaq(index) {
  const item = faqItems[index];
  const button = item.querySelector('.faq-question');
  const answer = item.querySelector('.faq-answer');

  isAnimating = true;

  // Collapse to 0 height
  answer.style.maxHeight = '0';

  // Update visual state
  button.classList.remove('active');
  button.setAttribute('aria-expanded', 'false');

  setTimeout(() => { isAnimating = false; }, 300);
}
```

### Event Listeners

**Click Events:**
```javascript
faqItems.forEach((item, index) => {
  const button = item.querySelector('.faq-question');

  button.addEventListener('click', (e) => {
    e.preventDefault();
    toggleFaq(index);
  });
});
```

**Keyboard Events:**
```javascript
document.addEventListener('keydown', (e) => {
  if (e.target.classList.contains('faq-question')) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      const index = Array.from(faqItems).indexOf(e.target.closest('.faq-item'));
      toggleFaq(index);
    } else if (e.key === 'Escape' && currentlyOpenIndex !== null) {
      e.preventDefault();
      closeFaq(currentlyOpenIndex);
      currentlyOpenIndex = null;
    }
  }
});
```

### Accessibility Features

**ARIA Attributes:**
- `role="region"` on accordion container
- `aria-label="Frequently asked questions"` on accordion
- `aria-expanded="true/false"` on each question button
- `aria-controls="answer-{index}"` linking button to answer
- Each answer has unique `id="answer-{index}"`

**Keyboard Navigation:**
- Tab through question buttons (native focus)
- Enter or Space to toggle expanded/collapsed
- Escape to close currently open FAQ
- All interactive elements keyboard accessible

**Screen Reader Support:**
- Buttons announce expanded/collapsed state
- Answer content readable when expanded
- Semantic heading structure maintained

**Reduced Motion:**
```css
@media (prefers-reduced-motion: reduce) {
  .faq-answer,
  .faq-chevron {
    transition: none;
  }
}
```

**Focus Management:**
- Visible focus indicators on buttons
- Focus remains on button after expand/collapse
- Outline offset for better visibility

### Animation Details

**CSS Transitions:**
```css
.faq-answer {
  max-height: 0;
  overflow: hidden;
  transition: max-height 300ms ease-in-out;
}

.faq-chevron {
  transition: transform 200ms ease;
}

.faq-question.active .faq-chevron {
  transform: rotate(90deg);
}
```

**No JavaScript Animation:**
- All animations handled by CSS transitions
- JavaScript only sets max-height values
- More performant, respects user preferences

## Implementation Tasks

### 1. Create FaqGenerator

**File:** `lib/jojo/generators/faq_generator.rb`

**Responsibilities:**
- Accept employer, ai_client, config, inputs
- Build prompt using FaqPrompt
- Call AI with reasoning model
- Parse JSON response
- Validate FAQ structure
- Save to `employers/{slug}/faq.json`
- Return array of FAQ hashes

**Error Handling:**
- Catch JSON parse errors
- Validate question/answer fields present
- Filter out invalid FAQ items
- Log warnings for degraded output
- Return empty array on complete failure

### 2. Create FaqPrompt

**File:** `lib/jojo/prompts/faq_prompt.rb`

**Method:** `self.generate_faq_prompt(job_description:, resume:, research:, job_details:, base_url:, seeker_name:, voice_and_tone:)`

**Prompt Sections:**
- Context (job description, resume, research)
- Instructions (categories, guidelines, format)
- Output specification (JSON structure)
- Examples (1-2 example FAQs)

### 3. Update WebsiteGenerator

**File:** `lib/jojo/generators/website_generator.rb`

**Changes:**
- Add `generate_faqs` method
- Call it during `generate` workflow
- Pass FAQs to `prepare_template_vars`
- Handle nil/empty FAQ gracefully

**New Method:**
```ruby
def generate_faqs
  return nil unless File.exist?(employer.resume_path)

  generator = FaqGenerator.new(
    employer,
    ai_client,
    config: config,
    verbose: verbose
  )

  generator.generate
rescue => e
  log "Error generating FAQs: #{e.message}"
  nil
end
```

### 4. Update Template

**File:** `templates/website/default.html.erb`

**New Section (between projects and CTA):**
```erb
<% if faqs && !faqs.empty? %>
<section class="faq">
  <h2>Your Questions, Answered</h2>
  <div class="faq-accordion" role="region" aria-label="Frequently asked questions">
    <% faqs.each_with_index do |faq, index| %>
    <div class="faq-item">
      <button class="faq-question" aria-expanded="false" aria-controls="answer-<%= index %>">
        <%= faq[:question] %>
        <span class="faq-chevron" aria-hidden="true">›</span>
      </button>
      <div class="faq-answer" id="answer-<%= index %>">
        <p><%= faq[:answer] %></p>
      </div>
    </div>
    <% end %>
  </div>
</section>
<% end %>
```

**New CSS:** Add all FAQ styling in `<style>` section

**New JavaScript:** Add accordion behavior script

### 5. Update Employer Class

**File:** `lib/jojo/employer.rb`

**New Method:**
```ruby
def faq_path
  File.join(employer_dir, 'faq.json')
end
```

## Testing Strategy

### Unit Tests: FaqGenerator

**File:** `test/unit/faq_generator_test.rb`

**Tests:**
1. Generate FAQs with all inputs (job description, resume, research)
2. Generate FAQs without research (graceful degradation)
3. Parse valid JSON response from AI
4. Handle malformed JSON from AI (return empty array)
5. Validate FAQ structure (question and answer present)
6. Filter out invalid FAQ items
7. Save FAQs to faq.json file
8. Error handling for AI failures

**Expected:** ~8 tests

### Unit Tests: FaqPrompt

**File:** `test/unit/faq_prompt_test.rb`

**Tests:**
1. Prompt includes job description
2. Prompt includes resume
3. Prompt includes research when available
4. Prompt includes base URL for PDF links
5. Prompt specifies required categories
6. Prompt gracefully handles missing research
7. Prompt includes voice and tone

**Expected:** ~5 tests

### Unit Tests: WebsiteGenerator

**File:** `test/unit/website_generator_test.rb` (add to existing)

**New Tests:**
1. Load and pass FAQs to template variables
2. Handle missing faq.json gracefully
3. FAQ section position (after projects, before CTA)

**Expected:** ~3 additional tests

### Integration Tests: FAQ Workflow

**File:** `test/integration/faq_workflow_test.rb`

**Tests:**
1. Full workflow: generate FAQs → save → render in website
2. Verify FAQ section HTML structure
3. Verify JavaScript included when FAQs present
4. No FAQs → section not rendered
5. Graceful degradation in generate command

**Expected:** ~4 tests

### Test Fixtures

**Files to create:**
- `test/fixtures/faq_valid.json` - Valid FAQ data
- `test/fixtures/faq_malformed.json` - Invalid JSON for error handling
- Mock AI responses in tests

### Expected Total Coverage

- ~8 tests for FaqGenerator
- ~5 tests for FaqPrompt
- ~3 additional tests for WebsiteGenerator
- ~4 integration tests
- **Total: ~20 new tests**

## Success Criteria

- ✅ AI generates 5-8 relevant FAQs based on job description and resume
- ✅ FAQ covers all required categories (tech, remote, AI, why company, documents)
- ✅ Answers reference specific resume evidence and research insights
- ✅ Single-expand accordion behavior works smoothly
- ✅ Keyboard navigation fully functional (Tab, Enter, Space, Escape)
- ✅ Smooth expand/collapse animations (300ms)
- ✅ Resume and cover letter download links work
- ✅ FAQ positioned between projects and CTA
- ✅ Graceful degradation (no FAQs → section not rendered)
- ✅ All tests passing (~20 new tests)
- ✅ Responsive design works on mobile and desktop
- ✅ Screen reader accessible (ARIA attributes correct)
- ✅ Reduced motion preference respected

## Future Enhancements

- Custom FAQ topics in `inputs/faq_topics.yml` (user can add company-specific questions)
- FAQ analytics tracking (which questions get expanded most)
- AI-generated follow-up questions based on job description analysis
- Multi-language FAQ generation for international applications
- FAQ search/filter functionality for long lists
- "Jump to FAQ" links from other sections (e.g., "See FAQ about remote work")
