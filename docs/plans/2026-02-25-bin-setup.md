# bin/setup Bootstrap Script Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create `./bin/setup`, a bash script that bootstraps a fresh clone to a runnable state before handing off to `./bin/jojo setup`.

**Architecture:** Sequential bash script with a `check_and_install` helper. Runs before Ruby is available so it handles all system-level prerequisites: Ruby version check, `bundle install`, `npm install`, and system dep checks (pandoc, wkhtmltopdf). Supports a `--check` flag for non-destructive environment inspection.

**Tech Stack:** bash, Homebrew (macOS), apt-get (Debian/Ubuntu)

---

### Task 1: Create script skeleton

**Files:**
- Create: `bin/setup`

**Step 1: Create the file with shebang, safety flags, color codes, and --check flag parsing**

```bash
#!/usr/bin/env bash
set -e

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Parse flags
CHECK_ONLY=false
for arg in "$@"; do
  case $arg in
    --check) CHECK_ONLY=true ;;
  esac
done

if $CHECK_ONLY; then
  echo "Checking environment (--check mode, no changes will be made)..."
  echo ""
fi
```

**Step 2: Make it executable**

```bash
chmod +x bin/setup
```

**Step 3: Verify it runs**

```bash
./bin/setup --check
```

Expected output:
```
Checking environment (--check mode, no changes will be made)...

```

**Step 4: Commit**

```bash
git add bin/setup
git commit -m "feat: add bin/setup skeleton with --check flag"
```

---

### Task 2: Ruby version check

**Files:**
- Modify: `bin/setup`

The required version lives in `.ruby-version`. We read it, get the running version, and exit 1 with helpful instructions if they don't match.

**Step 1: Add Ruby version check after the flag parsing block**

```bash
# Step 1: Check Ruby version
echo "Checking Ruby version..."
required_ruby="$(cat .ruby-version | tr -d '[:space:]')"
current_ruby="$(ruby -v 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)"

if [[ -z "$current_ruby" ]]; then
  echo -e "${RED}✗ Ruby not found${NC}"
  echo "  Install Ruby $required_ruby:"
  echo "    rbenv: rbenv install $required_ruby && rbenv global $required_ruby"
  echo "    mise:  mise use -g ruby@$required_ruby"
  exit 1
fi

if [[ "$current_ruby" != "$required_ruby" ]]; then
  echo -e "${RED}✗ Ruby version mismatch${NC}"
  echo "  Required: $required_ruby"
  echo "  Found:    $current_ruby"
  echo "  Install the correct version:"
  echo "    rbenv: rbenv install $required_ruby && rbenv global $required_ruby"
  echo "    mise:  mise use -g ruby@$required_ruby"
  exit 1
fi

echo -e "${GREEN}✓ Ruby $current_ruby${NC}"
```

**Step 2: Verify the happy path**

```bash
./bin/setup --check
```

Expected (assuming correct Ruby version is active):
```
Checking environment (--check mode, no changes will be made)...

Checking Ruby version...
✓ Ruby 3.4.5
```

**Step 3: Commit**

```bash
git add bin/setup
git commit -m "feat: add Ruby version check to bin/setup"
```

---

### Task 3: bundle install step

**Files:**
- Modify: `bin/setup`

In `--check` mode, look for `Gemfile.lock` as a proxy for "gems installed". In normal mode, run `bundle install`.

**Step 1: Add gem install step after the Ruby check**

```bash
# Step 2: Install Ruby gems
if $CHECK_ONLY; then
  if [[ -f "Gemfile.lock" ]]; then
    echo -e "${GREEN}✓ Ruby gems installed (Gemfile.lock present)${NC}"
  else
    echo -e "${YELLOW}⚠ Gemfile.lock not found — run ./bin/setup to install gems${NC}"
  fi
else
  echo "Installing Ruby gems..."
  bundle install
  echo -e "${GREEN}✓ Ruby gems installed${NC}"
fi
```

**Step 2: Verify**

```bash
./bin/setup --check
```

Expected addition to output:
```
✓ Ruby gems installed (Gemfile.lock present)
```

**Step 3: Commit**

```bash
git add bin/setup
git commit -m "feat: add bundle install step to bin/setup"
```

---

### Task 4: npm install step

**Files:**
- Modify: `bin/setup`

The `templates/website/` directory has Tailwind/DaisyUI build deps. In `--check` mode, look for the `node_modules` directory.

**Step 1: Add npm install step**

```bash
# Step 3: Install npm packages (website template build deps)
if $CHECK_ONLY; then
  if [[ -d "templates/website/node_modules" ]]; then
    echo -e "${GREEN}✓ npm packages installed${NC}"
  else
    echo -e "${YELLOW}⚠ templates/website/node_modules not found — run ./bin/setup to install${NC}"
  fi
else
  echo "Installing npm packages..."
  (cd templates/website && npm install)
  echo -e "${GREEN}✓ npm packages installed${NC}"
fi
```

**Step 2: Verify**

```bash
./bin/setup --check
```

Expected addition to output:
```
✓ npm packages installed
```

**Step 3: Commit**

```bash
git add bin/setup
git commit -m "feat: add npm install step to bin/setup"
```

---

### Task 5: check_and_install helper function

**Files:**
- Modify: `bin/setup`

Place this function near the top of the file, after the color code definitions and before the flag parsing block. The `brew_type` parameter is `"formula"` or `"cask"` — needed because wkhtmltopdf is a Homebrew cask on macOS while pandoc is a formula.

**Step 1: Add helper function**

```bash
# Check for a system dependency and optionally install it.
# Usage: check_and_install <label> <brew_formula> <brew_type> <apt_package>
#   brew_type: "formula" or "cask"
check_and_install() {
  local label="$1"
  local brew_formula="$2"
  local brew_type="$3"
  local apt_package="$4"

  if command -v "$label" > /dev/null 2>&1; then
    echo -e "${GREEN}✓ $label already installed${NC}"
    return
  fi

  if $CHECK_ONLY; then
    echo -e "${YELLOW}⚠ $label not found (required for 'jojo pdf')${NC}"
    return
  fi

  read -rp "$label not found. Install it? [y/N] " reply
  echo
  if [[ "$reply" =~ ^[Yy]$ ]]; then
    local os
    os="$(uname -s)"
    case "$os" in
      Darwin)
        if ! command -v brew > /dev/null 2>&1; then
          echo -e "${RED}✗ Homebrew not found${NC}"
          echo "  Install Homebrew from https://brew.sh, then re-run ./bin/setup"
          exit 1
        fi
        if [[ "$brew_type" == "cask" ]]; then
          brew install --cask "$brew_formula"
        else
          brew install "$brew_formula"
        fi
        ;;
      Linux)
        if command -v apt-get > /dev/null 2>&1; then
          sudo apt-get install -y "$apt_package"
        else
          echo -e "${YELLOW}  Unsupported Linux package manager${NC}"
          echo "  Install $label manually, then re-run ./bin/setup"
        fi
        ;;
      *)
        echo -e "${YELLOW}  Unsupported OS: $os${NC}"
        echo "  Install $label manually, then re-run ./bin/setup"
        ;;
    esac
  else
    echo -e "${YELLOW}  Skipping $label. Note: 'jojo pdf' requires $label.${NC}"
  fi
}
```

**Step 2: Verify the script still runs cleanly**

```bash
./bin/setup --check
```

Expected: same output as before (helper is defined but not yet called).

**Step 3: Commit**

```bash
git add bin/setup
git commit -m "feat: add check_and_install helper to bin/setup"
```

---

### Task 6: pandoc check/install step

**Files:**
- Modify: `bin/setup`

**Step 1: Add pandoc step after the npm step**

```bash
# Step 4: Check/install pandoc (required for 'jojo pdf')
echo ""
check_and_install "pandoc" "pandoc" "formula" "pandoc"
```

**Step 2: Verify**

```bash
./bin/setup --check
```

Expected addition (pandoc installed):
```

✓ pandoc already installed
```

Expected addition (pandoc missing):
```

⚠ pandoc not found (required for 'jojo pdf')
```

**Step 3: Commit**

```bash
git add bin/setup
git commit -m "feat: add pandoc check/install step to bin/setup"
```

---

### Task 7: wkhtmltopdf check/install step

**Files:**
- Modify: `bin/setup`

Note: Before implementing, verify `wkhtmltopdf` is still available as a Homebrew cask by checking https://formulae.brew.sh/cask/wkhtmltopdf. If the cask has been removed, update the macOS install path to print manual download instructions (https://wkhtmltopdf.org/downloads.html) instead of running `brew install`.

**Step 1: Add wkhtmltopdf step after the pandoc step**

```bash
# Step 5: Check/install wkhtmltopdf (required for 'jojo pdf')
check_and_install "wkhtmltopdf" "wkhtmltopdf" "cask" "wkhtmltopdf"
```

**Step 2: Verify**

```bash
./bin/setup --check
```

Expected addition:
```
✓ wkhtmltopdf already installed
```
or:
```
⚠ wkhtmltopdf not found (required for 'jojo pdf')
```

**Step 3: Commit**

```bash
git add bin/setup
git commit -m "feat: add wkhtmltopdf check/install step to bin/setup"
```

---

### Task 8: Bootstrap complete message and jojo setup prompt

**Files:**
- Modify: `bin/setup`

This block only runs in normal (non-`--check`) mode.

**Step 1: Add the completion block after the wkhtmltopdf step**

```bash
# Bootstrap complete
if ! $CHECK_ONLY; then
  echo ""
  echo -e "${GREEN}Bootstrap complete!${NC}"
  echo ""
  read -rp "Run './bin/jojo setup' to configure API keys and preferences? [Y/n] " reply
  echo
  if [[ ! "$reply" =~ ^[Nn]$ ]]; then
    ./bin/jojo setup
  else
    echo "Run './bin/jojo setup' when you're ready to configure your API keys."
    echo ""
  fi
fi
```

**Step 2: Run full --check to verify clean output**

```bash
./bin/setup --check
```

Expected full output (all deps present):
```
Checking environment (--check mode, no changes will be made)...

Checking Ruby version...
✓ Ruby 3.4.5
✓ Ruby gems installed (Gemfile.lock present)
✓ npm packages installed

✓ pandoc already installed
✓ wkhtmltopdf already installed
```

**Step 3: Commit**

```bash
git add bin/setup
git commit -m "feat: add bootstrap complete prompt and jojo setup chain"
```

---

### Task 9: Update README

**Files:**
- Modify: `README.md`

The current Quick Install section tells users to run `bundle install` then `./bin/jojo setup` separately. Replace with the single `./bin/setup` command.

**Step 1: Read README.md and locate the "Quick install" section**

**Step 2: Replace the quick install block**

Change:
```markdown
## Quick install

```bash
git clone https://github.com/grymoire7/jojo.git
cd jojo
bundle install
./bin/jojo setup
```

The setup wizard guides you through provider selection, API key configuration, and model selection. Then customize `inputs/resume_data.yml` with your experience and run:
```

To:
```markdown
## Quick install

```bash
git clone https://github.com/grymoire7/jojo.git
cd jojo
./bin/setup
```

`./bin/setup` installs Ruby gems, npm packages, and checks for system dependencies
(pandoc, wkhtmltopdf for PDF export), then runs the configuration wizard for your
API keys and preferences. Then customize `inputs/resume_data.yml` with your experience and run:
```

**Step 3: Verify the README reads cleanly**

```bash
cat README.md
```

Confirm the old `bundle install` line is gone and the description of `./bin/setup` is accurate.

**Step 4: Commit**

```bash
git add README.md
git commit -m "docs: update README quick install to use ./bin/setup"
```

---

### Task 10: Update docs/getting-started/installation.md

**Files:**
- Modify: `docs/getting-started/installation.md`

Currently this page lists pandoc and wkhtmltopdf as manual prerequisites with individual install commands, then walks through `bundle install` + `./bin/jojo setup` as separate steps. Update it to reflect that `./bin/setup` handles all of this.

**Step 1: Read `docs/getting-started/installation.md`**

**Step 2: Update the Prerequisites section**

The Prerequisites section should still list Ruby and an AI provider API key as things users must have before running `./bin/setup`, but remove pandoc/wkhtmltopdf (the script handles those interactively). Change:

```markdown
## Prerequisites

- **Ruby 3.4.5** — Install via [rbenv](https://github.com/rbenv/rbenv) or your preferred Ruby version manager
- **Bundler** — Install with `gem install bundler`
- **AI Provider API Key** — Jojo supports all providers available through [RubyLLM](https://rubyllm.com/available-models/) (Anthropic, OpenAI, Gemini, etc.)
- **Search API Key** — For web research capabilities:
  - [Serper](https://serper.dev/) API key, or
  - [Tavily](https://tavily.com/) API key
- **Pandoc** (optional) — For PDF generation: `brew install pandoc` on macOS
- **wkhtmltopdf** (optional) — For PDF generation: `brew install --cask wkhtmltopdf` on macOS
```

To:

```markdown
## Prerequisites

- **Ruby 3.4.5** — Install via [rbenv](https://github.com/rbenv/rbenv) or [mise](https://mise.jdx.dev/) before running setup
- **AI Provider API Key** — Jojo supports all providers available through [RubyLLM](https://rubyllm.com/available-models/) (Anthropic, OpenAI, Gemini, etc.)
- **Search API Key** (optional) — For web research capabilities:
  - [Serper](https://serper.dev/) API key, or
  - [Tavily](https://tavily.com/) API key
```

**Step 3: Update the Install Jojo section**

Replace the three-step manual process:

```markdown
## Install Jojo

1. Clone the repository:

   ```bash
   git clone https://github.com/grymoire7/jojo.git
   cd jojo
   ```

2. Install dependencies:

   ```bash
   bundle install
   ```

3. Run setup:

   ```bash
   ./bin/jojo setup
   ```

   The setup wizard guides you through provider selection, API key configuration, and model selection. See the [setup command](../commands/setup) for details.
```

With a single command:

```markdown
## Install Jojo

1. Clone the repository:

   ```bash
   git clone https://github.com/grymoire7/jojo.git
   cd jojo
   ```

2. Run the bootstrap script:

   ```bash
   ./bin/setup
   ```

   This installs Ruby gems, npm packages, and checks for optional system dependencies
   (pandoc and wkhtmltopdf for PDF export — offering to install them if missing). It then
   runs the configuration wizard to set up your API keys and preferences.
   See the [setup command](../commands/setup) for details on the configuration wizard.
```

**Step 4: Verify the page reads cleanly**

```bash
cat docs/getting-started/installation.md
```

**Step 5: Commit**

```bash
git add docs/getting-started/installation.md
git commit -m "docs: update installation guide to use ./bin/setup"
```

---

### Task 11: Update docs/getting-started/quick-start.md

**Files:**
- Modify: `docs/getting-started/quick-start.md`

The "Step 0" currently tells users to run `./bin/jojo setup`. For users arriving after the installation guide, they've already run `./bin/setup`. Update Step 0 to reflect the new flow.

**Step 1: Read `docs/getting-started/quick-start.md`**

**Step 2: Update Step 0**

Change:

```markdown
## Step 0: Setup and customize inputs

If you haven't already, run setup and customize your input files:

```bash
./bin/jojo setup
```
```

To:

```markdown
## Step 0: Setup and customize inputs

If you haven't already, bootstrap and configure Jojo:

```bash
./bin/setup        # installs deps and runs the configuration wizard
```

If you've already run `./bin/setup`, you can re-run the configuration wizard alone:

```bash
./bin/jojo setup
```
```

**Step 3: Verify the page reads cleanly**

```bash
cat docs/getting-started/quick-start.md
```

**Step 4: Commit**

```bash
git add docs/getting-started/quick-start.md
git commit -m "docs: update quick-start guide to reference ./bin/setup"
```

---

### Task 12: CI integration

**Files:**
- Modify: `.github/workflows/ruby.yml`

Add `./bin/setup --check` as a step so CI verifies the detection logic runs on Ubuntu.

**Step 1: Read `.github/workflows/ruby.yml`**

**Step 2: Add the check step after "Set up Ruby" and before "Install dependencies"**

```yaml
    - name: Check setup script
      run: ./bin/setup --check
```

**Step 3: Verify YAML**

```bash
cat .github/workflows/ruby.yml
```

Confirm 2-space indentation is consistent and the new step is inside the `steps` block.

**Step 4: Commit**

```bash
git add .github/workflows/ruby.yml
git commit -m "ci: add bin/setup --check step to verify bootstrap detection"
```

---

## Validation

After all tasks are complete:

```bash
# Verify executable and shebang
ls -la bin/setup
head -1 bin/setup

# Verify full check output
./bin/setup --check
```

Expected:
```
-rwxr-xr-x  ...  bin/setup
#!/usr/bin/env bash

Checking environment (--check mode, no changes will be made)...

Checking Ruby version...
✓ Ruby 3.4.5
✓ Ruby gems installed (Gemfile.lock present)
✓ npm packages installed

✓ pandoc already installed
✓ wkhtmltopdf already installed
```
