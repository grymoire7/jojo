#!/usr/bin/env bash
set -e

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for a system dependency and optionally install it.
# Usage: check_and_install <label> <brew_formula> <brew_type> <apt_package>
#   brew_type: "formula" or "cask"
check_and_install() {
  local label="$1"
  local brew_formula="$2"
  local brew_type="$3"
  local apt_package="$4"

  if command -v "$label" > /dev/null 2>&1; then
    echo -e "${GREEN}✓ $label already installed${NC}"
    return
  fi

  if $CHECK_ONLY; then
    echo -e "${YELLOW}⚠ $label not found (required for 'jojo pdf')${NC}"
    return
  fi

  read -rp "$label not found. Install it? [y/N] " reply
  echo
  if [[ "$reply" =~ ^[Yy]$ ]]; then
    local os
    os="$(uname -s)"
    case "$os" in
      Darwin)
        if ! command -v brew > /dev/null 2>&1; then
          echo -e "${RED}✗ Homebrew not found${NC}"
          echo "  Install Homebrew from https://brew.sh, then re-run ./bin/setup"
          exit 1
        fi
        if [[ "$brew_type" == "cask" ]]; then
          brew install --cask "$brew_formula"
        else
          brew install "$brew_formula"
        fi
        ;;
      Linux)
        if command -v apt-get > /dev/null 2>&1; then
          sudo apt-get install -y "$apt_package"
        else
          echo -e "${YELLOW}  Unsupported Linux package manager${NC}"
          echo "  Install $label manually, then re-run ./bin/setup"
        fi
        ;;
      *)
        echo -e "${YELLOW}  Unsupported OS: $os${NC}"
        echo "  Install $label manually, then re-run ./bin/setup"
        ;;
    esac
  else
    echo -e "${YELLOW}  Skipping $label. Note: 'jojo pdf' requires $label.${NC}"
  fi
}

# Parse flags
CHECK_ONLY=false
for arg in "$@"; do
  case $arg in
    --check) CHECK_ONLY=true ;;
  esac
done

if $CHECK_ONLY; then
  echo "Checking environment (--check mode, no changes will be made)..."
  echo ""
fi

# Step 1: Check Ruby version
echo "Checking Ruby version..."
required_ruby="$(cat .ruby-version | tr -d '[:space:]')"
current_ruby="$(ruby -v 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)"

if [[ -z "$current_ruby" ]]; then
  echo -e "${RED}✗ Ruby not found${NC}"
  echo "  Install Ruby $required_ruby:"
  echo "    rbenv: rbenv install $required_ruby && rbenv global $required_ruby"
  echo "    mise:  mise use -g ruby@$required_ruby"
  exit 1
fi

if [[ "$current_ruby" != "$required_ruby" ]]; then
  echo -e "${RED}✗ Ruby version mismatch${NC}"
  echo "  Required: $required_ruby"
  echo "  Found:    $current_ruby"
  echo "  Install the correct version:"
  echo "    rbenv: rbenv install $required_ruby && rbenv global $required_ruby"
  echo "    mise:  mise use -g ruby@$required_ruby"
  exit 1
fi

echo -e "${GREEN}✓ Ruby $current_ruby${NC}"

# Step 2: Install Ruby gems
if $CHECK_ONLY; then
  if [[ -f "Gemfile.lock" ]]; then
    echo -e "${GREEN}✓ Ruby gems installed (Gemfile.lock present)${NC}"
  else
    echo -e "${YELLOW}⚠ Gemfile.lock not found — run ./bin/setup to install gems${NC}"
  fi
else
  echo "Installing Ruby gems..."
  bundle install
  echo -e "${GREEN}✓ Ruby gems installed${NC}"
fi

# Step 3: Install npm packages (website template build deps)
if $CHECK_ONLY; then
  if [[ -d "templates/website/node_modules" ]]; then
    echo -e "${GREEN}✓ npm packages installed${NC}"
  else
    echo -e "${YELLOW}⚠ templates/website/node_modules not found — run ./bin/setup to install${NC}"
  fi
else
  echo "Installing npm packages..."
  (cd templates/website && npm install)
  echo -e "${GREEN}✓ npm packages installed${NC}"
fi

# Step 4: Check/install pandoc (required for 'jojo pdf')
echo ""
check_and_install "pandoc" "pandoc" "formula" "pandoc"
