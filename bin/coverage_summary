#!/usr/bin/env ruby
# frozen_string_literal: true

# Prints a coverage report from the last test run, grouped by component.
# Reads coverage/coverage.json (generated by SimpleCov after ./bin/test).
#
# Usage:
#   ./bin/coverage_summary            # default: show files under 80%
#   ./bin/coverage_summary --all      # list every file with its coverage
#   ./bin/coverage_summary --threshold 90  # change the "low coverage" cutoff

require "json"

if ARGV.include?("--help") || ARGV.include?("-h")
  puts <<~HELP
    Usage: ./bin/coverage_summary [OPTIONS]

    Prints a coverage report from the last test run.

    Options:
      --all              Show every file, not just low-coverage ones
      --threshold N      Set the "low coverage" cutoff (default: 80)
      -h, --help         Show this help message

    Prerequisites:
      Run ./bin/test first to generate coverage/coverage.json.
  HELP
  exit 0
end

show_all = ARGV.include?("--all")
threshold = 80
if (idx = ARGV.index("--threshold"))
  threshold = (ARGV[idx + 1] || 80).to_i
end

coverage_file = "coverage/coverage.json"

unless File.exist?(coverage_file)
  puts "No coverage data found. Run tests first:"
  puts "  ./bin/test"
  exit 1
end

data = JSON.parse(File.read(coverage_file))
project_root = File.expand_path("..", __dir__)

files = data["coverage"].map do |path, info|
  lines = info["lines"]
  relevant = lines.compact
  covered = relevant.count { |n| n > 0 }
  missed = relevant.count { |n| n == 0 }
  total = relevant.size
  pct = total > 0 ? (covered.to_f / total * 100).round(1) : 100
  short_path = path.sub("#{project_root}/", "")
  {path: short_path, covered: covered, missed: missed, total: total, pct: pct}
end

# Group by component type
groups = {
  "Generators" => files.select { |f| f[:path].include?("lib/jojo/commands") && f[:path].end_with?("generator.rb") },
  "Prompts" => files.select { |f| f[:path].include?("lib/jojo/commands") && f[:path].end_with?("prompt.rb") },
  "Commands" => files.select { |f|
    f[:path].include?("lib/jojo/commands") &&
      !f[:path].end_with?("generator.rb") &&
      !f[:path].end_with?("prompt.rb")
  },
  "Core" => files.select { |f| f[:path].include?("lib/jojo") && !f[:path].include?("lib/jojo/commands") }
}

total_covered = files.sum { |f| f[:covered] }
total_lines = files.sum { |f| f[:total] }
overall_pct = (total_covered.to_f / total_lines * 100).round(1)

puts "## Overall Coverage: #{overall_pct}% (#{total_covered}/#{total_lines} lines)\n\n"

puts "## Coverage by Group\n\n"
groups.each do |name, group_files|
  next if group_files.empty?
  group_covered = group_files.sum { |f| f[:covered] }
  group_lines = group_files.sum { |f| f[:total] }
  pct = group_lines > 0 ? (group_covered.to_f / group_lines * 100).round(1) : 0
  puts "  #{name}: #{pct}% (#{group_covered}/#{group_lines} lines)"
end

if show_all
  puts "\n## All Files\n\n"
  files.sort_by { |f| f[:pct] }.each do |f|
    puts "  %5.1f%%  %-60s %d/%d lines" % [f[:pct], f[:path], f[:covered], f[:total]]
  end
else
  puts "\n## Lowest Coverage Files (under #{threshold}%)\n\n"
  low = files.select { |f| f[:pct] < threshold && f[:total] > 5 }.sort_by { |f| f[:pct] }
  if low.empty?
    puts "  All files above #{threshold}%!"
  else
    low.each do |f|
      puts "  %5.1f%%  %-60s %d lines uncovered" % [f[:pct], f[:path], f[:missed]]
    end
  end
end

puts "\n## Completely Untested Files\n\n"
untested = files.select { |f| f[:pct] == 0 && f[:total] > 0 }
if untested.empty?
  puts "  None!"
else
  untested.each { |f| puts "  #{f[:path]} (#{f[:total]} lines)" }
end
