<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="<%= seeker_name %> - Application for <%= company_name %>">
  <title><%= seeker_name %> | <%= company_name %><% if job_title %> - <%= job_title %><% end %></title>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --text-color: #1f2937;
      --text-light: #6b7280;
      --background: #ffffff;
      --background-alt: #f9fafb;
      --border-color: #e5e7eb;
      --max-width: 800px;
      --spacing-unit: 1rem;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--background);
      padding: 2rem 1rem;
    }

    .container {
      max-width: var(--max-width);
      margin: 0 auto;
    }

    /* Masthead Section */
    .masthead {
      text-align: center;
      padding: 3rem 0;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 3rem;
    }

    .masthead h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 1rem;
      line-height: 1.2;
    }

    .masthead h4 {
      font-size: 1.25rem;
      font-weight: 400;
      color: var(--text-light);
      margin-bottom: 2rem;
    }

    .masthead-image {
      margin: 2rem auto;
      max-width: 200px;
    }

    .masthead-image img {
      width: 100%;
      height: auto;
      border-radius: 50%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Branding Statement Section */
    .branding {
      background-color: var(--background-alt);
      padding: 3rem 2rem;
      border-radius: 8px;
      margin-bottom: 3rem;
    }

    .branding p {
      font-size: 1.125rem;
      line-height: 1.8;
      color: var(--text-color);
      margin-bottom: 1.5rem;
    }

    .branding p:last-child {
      margin-bottom: 0;
    }

    /* CTA Section */
    .cta-section {
      text-align: center;
      padding: 3rem 0;
      margin-bottom: 3rem;
    }

    .cta-button {
      display: inline-block;
      background-color: var(--primary-color);
      color: white;
      padding: 1rem 2.5rem;
      font-size: 1.125rem;
      font-weight: 600;
      text-decoration: none;
      border-radius: 6px;
      transition: background-color 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .cta-button:hover {
      background-color: var(--primary-hover);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    /* Projects Section */
    .projects {
      margin: 40px 0;
    }

    .project-list {
      display: grid;
      gap: 20px;
    }

    .project-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      background: white;
    }

    .project-card h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .project-meta {
      font-size: 0.9em;
      color: #666;
      margin: 10px 0;
    }

    .project-meta span {
      margin-right: 15px;
    }

    .project-links {
      margin-top: 15px;
    }

    .project-links a {
      display: inline-block;
      margin-right: 15px;
      color: #3498db;
      text-decoration: none;
    }

    .project-links a:hover {
      text-decoration: underline;
    }

    .project-image {
      width: 100%;
      max-width: 400px;
      height: auto;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    /* Annotated Job Description Section */
    .job-description-comparison {
      margin: 3rem 0;
      padding: 2rem;
      background-color: var(--background-alt);
      border-radius: 8px;
    }

    .job-description-comparison h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--text-color);
    }

    .job-description-content {
      background-color: var(--background);
      padding: 1.5rem;
      border-radius: 6px;
      line-height: 1.8;
    }

    .job-description-content p {
      margin-bottom: 1rem;
    }

    .job-description-content p:last-child {
      margin-bottom: 0;
    }

    .annotated {
      background-color: rgba(37, 99, 235, 0.15);
      cursor: pointer;
      border-radius: 2px;
      padding: 1px 2px;
      transition: background-color 0.2s;
      position: relative;
    }

    .annotated[data-tier="strong"] {
      background-color: rgba(37, 99, 235, 0.25);
    }

    .annotated[data-tier="moderate"] {
      background-color: rgba(37, 99, 235, 0.15);
    }

    .annotated[data-tier="mention"] {
      background-color: rgba(37, 99, 235, 0.08);
    }

    .annotated:hover,
    .annotated:focus {
      background-color: rgba(37, 99, 235, 0.3);
      outline: none;
    }

    .annotation-legend {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      font-size: 0.875rem;
      color: var(--text-light);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .legend-item .sample {
      display: inline-block;
      width: 40px;
      height: 16px;
      border-radius: 2px;
    }

    .legend-item .sample.strong {
      background-color: rgba(37, 99, 235, 0.25);
    }

    .legend-item .sample.moderate {
      background-color: rgba(37, 99, 235, 0.15);
    }

    .legend-item .sample.mention {
      background-color: rgba(37, 99, 235, 0.08);
    }

    .legend-hint {
      font-style: italic;
      margin-left: auto;
    }

    .annotation-tooltip {
      position: absolute;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0.75rem 1rem;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 150ms ease;
    }

    .annotation-tooltip.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .tooltip-content {
      font-size: 0.875rem;
      line-height: 1.5;
      color: var(--text-color);
    }

    .tooltip-arrow {
      position: absolute;
      width: 10px;
      height: 10px;
      background: white;
      border: 1px solid var(--border-color);
      transform: rotate(45deg);
      z-index: -1;
    }

    .annotation-tooltip.above .tooltip-arrow {
      bottom: -6px;
      left: 50%;
      margin-left: -5px;
      border-top: none;
      border-left: none;
    }

    .annotation-tooltip.below .tooltip-arrow {
      top: -6px;
      left: 50%;
      margin-left: -5px;
      border-bottom: none;
      border-right: none;
    }

    /* Footer Section */
    .footer {
      border-top: 2px solid var(--border-color);
      padding-top: 2rem;
      text-align: center;
      color: var(--text-light);
    }

    .footer-links {
      margin-top: 1rem;
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .footer-links a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
    }

    .footer-links a:hover {
      text-decoration: underline;
    }

    /* Responsive Design */
    @media (max-width: 640px) {
      body {
        padding: 1rem 0.5rem;
      }

      .masthead {
        padding: 2rem 0;
      }

      .masthead h1 {
        font-size: 1.875rem;
      }

      .masthead h4 {
        font-size: 1rem;
      }

      .branding {
        padding: 2rem 1.5rem;
      }

      .branding p {
        font-size: 1rem;
      }

      .cta-button {
        padding: 0.875rem 2rem;
        font-size: 1rem;
      }

      .footer-links {
        flex-direction: column;
        gap: 1rem;
      }

      .annotation-legend {
        flex-direction: column;
        align-items: flex-start;
      }

      .legend-hint {
        margin-left: 0;
      }

      .annotation-tooltip {
        max-width: calc(100vw - 2rem);
      }
    }

    /* Recommendations Carousel Section */
    .recommendations {
      margin: 3rem 0;
      padding: 2rem;
      background-color: var(--background-alt);
      border-radius: 8px;
    }

    .recommendations h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 2rem;
      color: var(--text-color);
    }

    .carousel-container {
      position: relative;
      overflow: hidden;
      max-width: 700px;
      margin: 0 auto;
    }

    .carousel-track {
      display: flex;
      transition: transform 300ms ease-in-out;
    }

    .carousel-slide {
      min-width: 100%;
      flex-shrink: 0;
      padding: 0 1rem;
    }

    .recommendation-card {
      background: var(--background);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 2.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .recommendation-card::before {
      content: '"';
      position: absolute;
      top: 1rem;
      left: 1.5rem;
      font-size: 4rem;
      line-height: 1;
      color: rgba(0, 0, 0, 0.1);
      font-family: Georgia, serif;
    }

    .recommendation-quote {
      font-size: 1.125rem;
      line-height: 1.8;
      color: var(--text-color);
      margin-bottom: 1.5rem;
      position: relative;
      z-index: 1;
    }

    .recommendation-attribution {
      font-size: 0.9rem;
      color: var(--text-light);
      font-style: italic;
    }

    .recommendation-attribution strong {
      font-weight: 600;
      color: var(--text-color);
      font-style: normal;
    }

    /* Carousel Navigation */
    .carousel-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--background);
      border: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: var(--text-color);
      transition: all 0.2s ease;
      z-index: 10;
    }

    .carousel-arrow:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .carousel-arrow.prev {
      left: -50px;
    }

    .carousel-arrow.next {
      right: -50px;
    }

    .carousel-arrow:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .carousel-dots {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border-color);
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
      padding: 0;
    }

    .carousel-dot.active {
      background: var(--primary-color);
    }

    .carousel-dot:hover {
      background: var(--primary-hover);
    }

    /* Single recommendation - no navigation */
    .recommendations.single-recommendation .carousel-arrow,
    .recommendations.single-recommendation .carousel-dots {
      display: none;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .recommendations {
        padding: 1.5rem 1rem;
      }

      .recommendation-card {
        padding: 2rem 1.5rem;
      }

      .recommendation-card::before {
        font-size: 3rem;
      }

      .recommendation-quote {
        font-size: 1rem;
      }

      .carousel-arrow {
        width: 32px;
        height: 32px;
        font-size: 1.25rem;
      }

      .carousel-arrow.prev {
        left: -40px;
      }

      .carousel-arrow.next {
        right: -40px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Masthead -->
    <header class="masthead">
      <h1>Am I a good match for <%= company_name %>?</h1>
      <h4><% if job_title %><%= job_title %> Candidate<% else %>Let's find out<% end %></h4>

      <% if has_branding_image %>
      <div class="masthead-image">
        <img src="<%= branding_image_path %>" alt="<%= seeker_name %>">
      </div>
      <% end %>
    </header>

    <!-- Branding Statement -->
    <section class="branding">
      <%= branding_statement.split("\n\n").map { |para| "<p>#{para}</p>" }.join("\n      ") %>
    </section>

    <!-- Annotated Job Description -->
    <% if annotated_job_description %>
    <section class="job-description-comparison">
      <h2>Compare Me to the Job Description</h2>
      <div class="job-description-content">
        <%= annotated_job_description %>
      </div>
      <p class="annotation-legend">
        <span class="legend-item"><span class="sample strong"></span> Strong match</span>
        <span class="legend-item"><span class="sample moderate"></span> Moderate match</span>
        <span class="legend-item"><span class="sample mention"></span> Worth a mention</span>
        <span class="legend-hint">Hover or tap highlighted text to see details</span>
      </p>
    </section>
    <% end %>

    <!-- Recommendations Carousel -->
    <% if recommendations && !recommendations.empty? %>
    <section class="recommendations<%= ' single-recommendation' if recommendations.size == 1 %>">
      <h2>What Others Say</h2>
      <div class="carousel-container">
        <div class="carousel-track">
          <% recommendations.each do |rec| %>
          <div class="carousel-slide">
            <div class="recommendation-card">
              <div class="recommendation-quote">
                <%= rec[:quote] %>
              </div>
              <div class="recommendation-attribution">
                <strong><%= rec[:recommender_name] %></strong><% if rec[:recommender_title] %>, <%= rec[:recommender_title] %><% end %>
                <br><%= rec[:relationship] %>
              </div>
            </div>
          </div>
          <% end %>
        </div>
        <button class="carousel-arrow prev" aria-label="Previous recommendation">‹</button>
        <button class="carousel-arrow next" aria-label="Next recommendation">›</button>
      </div>
      <div class="carousel-dots" role="tablist">
        <% recommendations.each_with_index do |_, index| %>
        <button class="carousel-dot<%= ' active' if index == 0 %>"
                aria-label="Go to recommendation <%= index + 1 %>"
                data-index="<%= index %>"></button>
        <% end %>
      </div>
    </section>
    <% end %>

    <!-- Call to Action -->
    <% if cta_link && !cta_link.strip.empty? %>
    <section class="cta-section">
      <a href="<%= cta_link %>" class="cta-button"><%= cta_text %></a>
    </section>
    <% end %>

    <!-- Projects Section -->
    <% if projects && !projects.empty? %>
    <section class="projects">
      <h2>Relevant Work</h2>
      <div class="project-list">
        <% projects.each do |project| %>
        <div class="project-card">
          <% if project[:image_url] %>
          <img src="<%= project[:image_url] %>" alt="<%= project[:title] %>" class="project-image">
          <% end %>
          <h3><%= project[:title] %></h3>
          <p><%= project[:description] %></p>
          <% if project[:context] || project[:year] %>
          <p class="project-meta">
            <% if project[:year] %><span><%= project[:year] %></span><% end %>
            <% if project[:context] %><span><%= project[:context] %></span><% end %>
          </p>
          <% end %>
          <% if project[:blog_post_url] || project[:github_url] || project[:live_url] %>
          <div class="project-links">
            <% if project[:blog_post_url] %><a href="<%= project[:blog_post_url] %>">Blog Post</a><% end %>
            <% if project[:github_url] %><a href="<%= project[:github_url] %>">GitHub</a><% end %>
            <% if project[:live_url] %><a href="<%= project[:live_url] %>">Live Demo</a><% end %>
          </div>
          <% end %>
        </div>
        <% end %>
      </div>
    </section>
    <% end %>

    <!-- Footer -->
    <footer class="footer">
      <p>Application materials for <%= company_name %></p>
      <div class="footer-links">
        <a href="<%= base_url %>/resume/<%= company_slug %>" target="_blank">View Resume</a>
        <a href="<%= base_url %>/cover-letter/<%= company_slug %>" target="_blank">View Cover Letter</a>
      </div>
    </footer>
  </div>

  <% if annotated_job_description %>
  <!-- Annotation tooltip container -->
  <div id="annotation-tooltip" class="annotation-tooltip">
    <div class="tooltip-content"></div>
    <div class="tooltip-arrow"></div>
  </div>

  <script>
  (function() {
    'use strict';

    const tooltip = document.getElementById('annotation-tooltip');
    const tooltipContent = tooltip.querySelector('.tooltip-content');
    const annotations = document.querySelectorAll('.annotated');
    const isTouchDevice = window.matchMedia('(hover: none)').matches;
    let currentAnnotation = null;

    // Show tooltip
    function showTooltip(annotation) {
      const match = annotation.dataset.match;
      if (!match) return;

      currentAnnotation = annotation;
      tooltipContent.textContent = match;

      // Position tooltip
      positionTooltip(annotation);

      // Show with animation
      tooltip.classList.add('visible');
    }

    // Hide tooltip
    function hideTooltip() {
      tooltip.classList.remove('visible');
      currentAnnotation = null;
    }

    // Position tooltip above or below annotation
    function positionTooltip(annotation) {
      const rect = annotation.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const spaceAbove = rect.top;
      const spaceBelow = viewportHeight - rect.bottom;

      // Decide position: above or below
      const showAbove = spaceAbove > tooltipRect.height + 10 && spaceBelow < tooltipRect.height + 10;

      if (showAbove) {
        tooltip.classList.add('above');
        tooltip.classList.remove('below');
        tooltip.style.top = (window.scrollY + rect.top - tooltipRect.height - 10) + 'px';
      } else {
        tooltip.classList.add('below');
        tooltip.classList.remove('above');
        tooltip.style.top = (window.scrollY + rect.bottom + 10) + 'px';
      }

      // Center horizontally
      const left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
      const maxLeft = window.innerWidth - tooltipRect.width - 10;
      tooltip.style.left = Math.max(10, Math.min(left, maxLeft)) + 'px';
    }

    // Add event listeners to each annotation
    annotations.forEach(function(annotation) {
      // Make focusable for keyboard navigation
      annotation.setAttribute('tabindex', '0');

      if (isTouchDevice) {
        // Touch: tap to show, tap outside to hide
        annotation.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (currentAnnotation === annotation) {
            hideTooltip();
          } else {
            showTooltip(annotation);
          }
        });
      } else {
        // Desktop: hover to show
        annotation.addEventListener('mouseenter', function() {
          showTooltip(annotation);
        });

        annotation.addEventListener('mouseleave', function() {
          hideTooltip();
        });
      }

      // Keyboard: Enter to show, Escape to hide
      annotation.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          showTooltip(annotation);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          hideTooltip();
        }
      });
    });

    // Click outside to close (for touch devices)
    if (isTouchDevice) {
      document.addEventListener('click', function(e) {
        if (!tooltip.contains(e.target) && !e.target.classList.contains('annotated')) {
          hideTooltip();
        }
      });
    }
  })();
  </script>
  <% end %>

  <% if recommendations && recommendations.size > 1 %>
  <!-- Recommendations Carousel JavaScript -->
  <script>
  (function() {
    'use strict';

    // Carousel state
    const carousel = {
      track: document.querySelector('.recommendations .carousel-track'),
      slides: document.querySelectorAll('.recommendations .carousel-slide'),
      prevBtn: document.querySelector('.recommendations .carousel-arrow.prev'),
      nextBtn: document.querySelector('.recommendations .carousel-arrow.next'),
      dots: document.querySelectorAll('.recommendations .carousel-dot'),
      currentIndex: 0,
      totalSlides: <%= recommendations.size %>,
      isTransitioning: false,
      autoAdvanceInterval: null,
      autoAdvanceDelay: 6000
    };

    // Go to specific slide
    function goToSlide(index) {
      if (carousel.isTransitioning) return;

      carousel.isTransitioning = true;
      carousel.currentIndex = index;

      // Update transform
      const offset = -index * 100;
      carousel.track.style.transform = `translateX(${offset}%)`;

      // Update dots
      carousel.dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });

      // Update ARIA
      carousel.slides.forEach((slide, i) => {
        slide.setAttribute('aria-hidden', i !== index);
      });

      setTimeout(() => {
        carousel.isTransitioning = false;
      }, 300);
    }

    // Next slide
    function nextSlide() {
      const next = (carousel.currentIndex + 1) % carousel.totalSlides;
      goToSlide(next);
    }

    // Previous slide
    function prevSlide() {
      const prev = (carousel.currentIndex - 1 + carousel.totalSlides) % carousel.totalSlides;
      goToSlide(prev);
    }

    // Auto-advance
    function startAutoAdvance() {
      if (carousel.autoAdvanceInterval) return;

      carousel.autoAdvanceInterval = setInterval(() => {
        nextSlide();
      }, carousel.autoAdvanceDelay);
    }

    function pauseAutoAdvance() {
      if (carousel.autoAdvanceInterval) {
        clearInterval(carousel.autoAdvanceInterval);
        carousel.autoAdvanceInterval = null;
      }
    }

    function resumeAutoAdvance() {
      pauseAutoAdvance();
      setTimeout(startAutoAdvance, 1000);
    }

    // Event listeners
    carousel.prevBtn.addEventListener('click', () => {
      prevSlide();
      pauseAutoAdvance();
    });

    carousel.nextBtn.addEventListener('click', () => {
      nextSlide();
      pauseAutoAdvance();
    });

    carousel.dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        goToSlide(index);
        pauseAutoAdvance();
      });
    });

    // Pause on hover
    const container = document.querySelector('.recommendations');
    container.addEventListener('mouseenter', pauseAutoAdvance);
    container.addEventListener('mouseleave', resumeAutoAdvance);

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.target.closest('.recommendations')) {
        if (e.key === 'ArrowLeft') {
          prevSlide();
          pauseAutoAdvance();
        } else if (e.key === 'ArrowRight') {
          nextSlide();
          pauseAutoAdvance();
        }
      }
    });

    // Initialize
    goToSlide(0);
    startAutoAdvance();

    // Pause when tab not visible
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        pauseAutoAdvance();
      } else {
        resumeAutoAdvance();
      }
    });
  })();
  </script>
  <% end %>
</body>
</html>
